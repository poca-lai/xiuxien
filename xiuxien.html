<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>修為與戰力計算器</title>



<style>
body { font-family: Arial, sans-serif; padding: 10px; max-width: 900px; margin: auto; }
h2 { text-align: center; }
fieldset { margin-top: 20px; padding: 10px; }
label { display: block; margin-top: 10px; }
select, input, button { 
margin-top: 5px; 
padding: 8px; 
font-size: 1em; 
width: 100%; 
box-sizing: border-box; 
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}
button { cursor: pointer; margin-top: 15px; }
#result, #powerResult { margin-top: 15px; font-weight: bold; }
hr { margin: 15px 0; }

.form-row {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 5px;
}
.form-row > label {
flex: 1 1 45%;
}
/* 修正版：所有 checkbox 左右排列，每行兩個 */
.checkbox-container {
display: flex;
flex-wrap: wrap;
gap: 10px;
}
.checkbox-container label {
flex: 1 1 calc(50% - 5px); /* 更穩定的兩欄佈局 */
display: flex;
align-items: center;
/* 確保文字不被擠壓 */
white-space: nowrap; 
}
/* 確保 checkbox 區塊的文字不會被 general label 樣式影響 */
.checkbox-container input[type="checkbox"] {
width: auto;
margin-right: 5px;
}

@media (min-width: 768px) {
.form-row {
flex-wrap: nowrap;
}
.form-row > label {
flex-grow: 1;
flex-basis: 0;
}
}
</style>



</head>
<body>

<h2>修仙計算機</h2>

<fieldset style="padding:10px; margin-bottom:20px;">
  <legend>修為計算</legend>

  <label>當前境界:
    <select id="stageSelect"></select>
  </label>
  <label>當前階段進度:
    <select id="subStageSelect">
      <option value="前期">前期</option>
      <option value="中期">中期</option>
      <option value="後期">後期</option>
    </select>
  </label>
  <label>目前經驗:
    <input type="number" id="currentExp" value="0">
  </label>
  <label>元氣丹補回:
    <input type="number" id="exExp" value="0">
  </label>
  <label>目標境界:
    <select id="targetSelect"></select>
  </label>

<label>冰心：
    <select id="bingxinSelect">
      <option value="0">0</option>
      <option value="1">1等</option>
      <option value="2">3等</option>
      <option value="3">5等</option>
    </select>
  </label>
  <label>親密加成：
    <select id="qinmiSelect">
      <option value="0">0</option>
      <option value="1">1人 5%</option>
      <option value="2">2人 10%</option>
      <option value="3">3人 15%</option>
    </select>
  </label>
<label>聚靈丹：
  <select id="julingdanSelect">
    <option value="0">0顆</option>
    <option value="1">1顆</option>
    <option value="2">2顆</option>
    <option value="3">3顆</option>
    <option value="4">4顆</option>
    <option value="5">5顆</option>
    <option value="6">6顆</option>
  </select>
  持續時間(hr):
  <select id="julingdanTime">
    <option value="0">0</option>
    <option value="0.5">0.5</option>
    <option value="1">1</option>
    <option value="1.5">1.5</option>
    <option value="2">2</option>
  </select>
</label>

<label>幽玄：
  <select id="youxuanSelect">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</label>

<label>天命：
  <select id="tianmingSelect">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</label>

<label>玄冥：
  <select id="xuanmingSelect">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</label>

<label>功法：
  <br>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="4">4
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="5">5
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="11">11
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="12">12
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="18">18
</label>
</label>

 <label>戰意：
    <input type="number" id="zhanyiInput" value="0">
  </label>

  <button onclick="calculate()">計算升滿時間</button>
  <div id="result"></div>
</fieldset>
<fieldset style="padding:10px;">
  <legend>戰力計算</legend>
  
  <label>戰力:
    <input type="number" id="currentPower" value="0">
  </label>

  <hr>
  <div>
    <strong>水書：</strong>
    <div class="checkbox-container">
      <div class="checkbox-column">
        <label><input type="checkbox" name="waterBook" value="3000">3000</label>
        <label><input type="checkbox" name="waterBook" value="15000">15000</label>
        <label><input type="checkbox" name="waterBook" value="30000">30000</label>
        <label><input type="checkbox" name="waterBook" value="3">3%</label>
      </div>
      <div class="checkbox-column">
        <label><input type="checkbox" name="waterBook" value="10000">10000</label>
        <label><input type="checkbox" name="waterBook" value="20000">20000</label>
        <label><input type="checkbox" name="waterBook" value="5">5%</label>
      </div>
    </div>
  </div>

  <div>
    <strong>火書：</strong>
    <div class="checkbox-container">
      <div class="checkbox-column">
        <label><input type="checkbox" name="fireBook" value="3000">3000</label>
        <label><input type="checkbox" name="fireBook" value="15000">15000</label>
        <label><input type="checkbox" name="fireBook" value="30000">30000</label>
        <label><input type="checkbox" name="fireBook" value="3">3%</label>
      </div>
      <div class="checkbox-column">
        <label><input type="checkbox" name="fireBook" value="10000">10000</label>
        <label><input type="checkbox" name="fireBook" value="20000">20000</label>
        <label><input type="checkbox" name="fireBook" value="5">5%</label>
      </div>
    </div>
  </div>

  <div>
    <strong>木書：</strong>
    <div class="checkbox-container">
      <div class="checkbox-column">
        <label><input type="checkbox" name="woodBook" value="3000">3000</label>
        <label><input type="checkbox" name="woodBook" value="15000">15000</label>
        <label><input type="checkbox" name="woodBook" value="30000">30000</label>
        <label><input type="checkbox" name="woodBook" value="3">3%</label>
      </div>
      <div class="checkbox-column">
        <label><input type="checkbox" name="woodBook" value="10000">10000</label>
        <label><input type="checkbox" name="woodBook" value="20000">20000</label>
        <label><input type="checkbox" name="woodBook" value="5">5%</label>
      </div>
    </div>
  </div>

  <button onclick="calculatePowerBooks()">計算最高戰力</button>
  <div id="powerBooksResult" style="margin-top:10px; font-weight:bold;"></div>
</fieldset>



<script>
// 經驗表
const stages = [
  { name: "1.凡人 前期", exp: 15, rate: 1 },
  { name: "1.凡人 中期", exp: 25, rate: 1 },
  { name: "1.凡人 後期", exp: 50, rate: 1 },
  { name: "2.煉氣 前期", exp: 100, rate: 1 },
  { name: "2.煉氣 中期", exp: 440, rate: 1 },
  { name: "2.煉氣 後期", exp: 900, rate: 1 },
  { name: "3.築基 前期", exp: 5400, rate: 3 },
  { name: "3.築基 中期", exp: 13000, rate: 3 },
  { name: "3.築基 後期", exp: 24150, rate: 3 },
  { name: "4.結丹 前期", exp: 25000, rate: 5 },
  { name: "4.結丹 中期", exp: 26000, rate: 5 },
  { name: "4.結丹 後期", exp: 44625, rate: 5 },
  { name: "5.元嬰 前期", exp: 48825, rate: 5 },
  { name: "5.元嬰 中期", exp: 51240, rate: 5 },
  { name: "5.元嬰 後期", exp: 54915, rate: 5 },
  { name: "6.出竅 前期", exp: 56490, rate: 5 },
  { name: "6.出竅 中期", exp: 59325, rate: 5 },
  { name: "6.出竅 後期", exp: 61950, rate: 5 },
  { name: "7.化神 前期", exp: 65415, rate: 5 },
  { name: "7.化神 中期", exp: 68670, rate: 5 },
  { name: "7.化神 後期", exp: 72135, rate: 5 },
  { name: "8.合體 前期", exp: 75705, rate: 10 },
  { name: "8.合體 中期", exp: 79485, rate: 10 },
  { name: "8.合體 後期", exp: 166950, rate: 10 },
  { name: "9.洞虛 前期", exp: 175350, rate: 10 },
  { name: "9.洞虛 中期", exp: 183750, rate: 10 },
  { name: "9.洞虛 後期", exp: 193200, rate: 10 },
  { name: "10.大成 前期", exp: 202965, rate: 10 },
  { name: "10.大成 中期", exp: 213150, rate: 10 },
  { name: "10.大成 後期", exp: 223650, rate: 10 },
  { name: "11.渡劫 前期", exp: 262500, rate: 10 },
  { name: "11.渡劫 中期", exp: 283500, rate: 10 },
  { name: "11.渡劫 後期", exp: 315000, rate: 10 },
  { name: "12.人仙 前期", exp: 1050000, rate: 30 },
  { name: "12.人仙 中期", exp: 861000, rate: 30 },
  { name: "12.人仙 後期", exp: 903000, rate: 30 },
  { name: "13.真仙 前期", exp: 924000, rate: 30 },
  { name: "13.真仙 中期", exp: 945000, rate: 30 },
  { name: "13.真仙 後期", exp: 950985, rate: 30 },
  { name: "14.金仙 前期", exp: 968100, rate: 30 },
  { name: "14.金仙 中期", exp: 985530, rate: 30 },
  { name: "14.金仙 後期", exp: 1003275, rate: 30 },
  { name: "15.上仙 前期", exp: 1020000, rate: 30 },
  { name: "15.上仙 中期", exp: 1039500, rate: 30 },
  { name: "15.上仙 後期", exp: 1058442, rate: 30 },
  { name: "16.仙君 前期", exp: 2520000, rate: 50 },
  { name: "16.仙君 中期", exp: 1890000, rate: 50 },
  { name: "16.仙君 後期", exp: 1942500, rate: 50 },
  { name: "17.仙尊 前期", exp: 2047500, rate: 50 },
  { name: "17.仙尊 中期", exp: 2252250, rate: 50 },
  { name: "17.仙尊 後期", exp: 2478000, rate: 50 },
  { name: "18.仙帝 前期", exp: 6300000, rate: 100 },
  { name: "18.仙帝 中期", exp: 7035000, rate: 100 },
  { name: "18.仙帝 後期", exp: 7035000, rate: 100 },
];

const stageSelect = document.getElementById('stageSelect');
const targetSelect = document.getElementById('targetSelect');
const subStageSelect = document.getElementById('subStageSelect');
const levels = [...new Set(stages.map(s => s.name.split(' ')[0]))];

// 初始化下拉選單
levels.forEach((lvl, i) => {
    const option1 = document.createElement('option');
    option1.value = i;
    option1.text = lvl;
    stageSelect.add(option1);

    const option2 = document.createElement('option');
    option2.value = i;
    option2.text = lvl;
    targetSelect.add(option2);
});

// 當前境界變化時，更新目標境界選單
stageSelect.addEventListener('change', () => {
    const currentVal = parseInt(stageSelect.value);

    // 清空 targetSelect
    targetSelect.innerHTML = '';

    // 只加入 >= 當前境界的選項
    levels.forEach((lvl, i) => {
        if (i >= currentVal) {
            const option = document.createElement('option');
            option.value = i;
            option.text = lvl;
            targetSelect.add(option);
        }
    });

    // 預設選中與當前境界相同
    targetSelect.value = currentVal;
});

function calculate() {
    let currentIndex = parseInt(stageSelect.value) * 3 + subStageSelect.selectedIndex;
    let targetIndex = parseInt(targetSelect.value) * 3 + 2; // 目標固定後期
    let currentExp = parseFloat(document.getElementById('currentExp').value) || 0;
    let exExp = parseFloat(document.getElementById('exExp').value) || 0;
    let zhanyi = parseInt(document.getElementById('zhanyiInput').value) || 0;

    let totalExpNeeded = 0;
    // 1. 計算當前境界到滿所需的經驗
    totalExpNeeded += stages[currentIndex].exp - (currentExp + exExp);
    // 2. 計算從下一個境界到目標境界滿所需的經驗
    for (let i = currentIndex + 1; i <= targetIndex; i++) {
        totalExpNeeded += stages[i].exp;
    }

    if (totalExpNeeded <= 0) {
        document.getElementById('result').innerHTML = `已經達到目標境界！`;
        return;
    }

    let totalTimeSec = 0;
    let remainingExp = totalExpNeeded;
    let remainingJDTime = parseFloat(document.getElementById('julingdanTime').value) * 3600; // 秒
    let currentZhanyi = zhanyi;
    let currentStageIndex = currentIndex;

    // 計算所有百分比加成 (固定加成)
    let percentBonus = 0;
    const youxuan = parseInt(document.getElementById('youxuanSelect').value);
    const tianming = parseInt(document.getElementById('tianmingSelect').value);
    const xuanming = parseInt(document.getElementById('xuanmingSelect').value);
    const qinmi = parseInt(document.getElementById('qinmiSelect').value);
    const checkedGongfa = Array.from(document.querySelectorAll('input[name="gongfaExp"]:checked')).map(cb => parseInt(cb.value));

    percentBonus += youxuan * 0.01 + tianming * 0.01 + xuanming * 0.01;
    if (qinmi > 0) percentBonus += 0.05 * qinmi;
    checkedGongfa.forEach(val => {
        if (val == 4 || val == 5) percentBonus += 0.05;
        else if (val == 11) percentBonus += 0.15;
        else if (val == 12) percentBonus += 0.3;
        else if (val == 18) percentBonus += 0.7;
    });
    
    const jdCount = parseInt(document.getElementById('julingdanSelect').value);
    let jdBonus = 0;
    if (jdCount > 0) {
        jdBonus = 0.2 + 0.04 * (jdCount - 1);
    }
    const bingxin = parseInt(document.getElementById('bingxinSelect').value);
    
    // 階段性計算經驗
    while (remainingExp > 0 && currentStageIndex <= targetIndex) {
        const baseRate = stages[currentStageIndex].rate;
        let expForCurrentStage = (currentStageIndex === currentIndex) ? (stages[currentStageIndex].exp - (currentExp + exExp)) : stages[currentStageIndex].exp;
        expForCurrentStage = Math.max(0, expForCurrentStage); // 確保不為負值

        while (expForCurrentStage > 0) {
            // 計算當前的戰意加成
            let zhanyiBonus = 0;
            if (currentZhanyi > 0) {
                if (currentZhanyi <= 500) zhanyiBonus = 0.03;
                else if (currentZhanyi <= 1000) zhanyiBonus = 0.05;
                else if (currentZhanyi <= 1500) zhanyiBonus = 0.07;
                else if (currentZhanyi <= 2000) zhanyiBonus = 0.15;
            }

            // 計算當前的總經驗速率
            let expRate = baseRate * (1 + percentBonus + zhanyiBonus) + bingxin;
            if (remainingJDTime > 0) {
                expRate = baseRate * (1 + percentBonus + jdBonus + zhanyiBonus) + bingxin;
            }

            // 計算這段時間需要多久
            // 取決於聚靈丹剩餘時間、戰意降級時間，或完成此境界所需時間
            const timeToNextZhanyiTier = (currentZhanyi - (Math.floor(currentZhanyi / 200) - 1) * 200) / (200 / 3600);
            const timeChunk = Math.min(
                remainingJDTime > 0 ? remainingJDTime : Infinity,
                expForCurrentStage / expRate,
                currentZhanyi > 0 ? 3600 : Infinity // 假設每小時整點扣除
            );

            // 計算這段時間內獲得的經驗
            const expGainedInChunk = expRate * timeChunk;

            // 更新數據
            totalTimeSec += timeChunk;
            expForCurrentStage -= expGainedInChunk;
            remainingJDTime -= timeChunk;
            
            // 扣除戰意，並確保是每小時扣除
            const hoursPassed = Math.floor(totalTimeSec / 3600);
            const hoursBefore = Math.floor((totalTimeSec - timeChunk) / 3600);
            if (hoursPassed > hoursBefore) {
              currentZhanyi = Math.max(0, currentZhanyi - 200);
            }

            if (expForCurrentStage <= 0) {
                break; // 完成此境界
            }
        }

        remainingExp -= stages[currentStageIndex].exp;
        currentStageIndex++;
    }

    // 轉換時間
    const hoursDuration = Math.floor(totalTimeSec / 3600);
    const minutesDuration = Math.floor((totalTimeSec % 3600) / 60);

    // 計算預計圓滿時間
    const now = new Date();
    const finalTime = new Date(now.getTime() + totalTimeSec * 1000);
    const year = finalTime.getFullYear();
    const month = (finalTime.getMonth() + 1).toString().padStart(2, '0');
    const day = finalTime.getDate().toString().padStart(2, '0');
    const hours = finalTime.getHours().toString().padStart(2, '0');
    const minutes = finalTime.getMinutes().toString().padStart(2, '0');

    document.getElementById('result').innerHTML =
        `總需求經驗: ${Math.round(totalExpNeeded)}<br>` +
        `預估所需時間: ${hoursDuration}小時 ${minutesDuration}分鐘<br>` +
        `預計圓滿時間: ${year}年${month}月${day}日 ${hours}:${minutes}`;
}






function calculatePowerBooks() {
  const currentPower = parseFloat(document.getElementById('currentPower').value) || 0;

  const attrs = [
    { name: 'waterBook', emoji: '💦' },
    { name: 'fireBook', emoji: '🔥' },
    { name: 'woodBook', emoji: '🪵' }
  ];

  let results = [];

  attrs.forEach(attr => {
    const checked = Array.from(document.querySelectorAll(`input[name="${attr.name}"]:checked`))
                         .map(cb => parseFloat(cb.value));

    // 分開數值和百分比
    let addExp = checked.filter(v => v >= 0 && v <= 30000).reduce((a,b)=>a+b, 0);
    let addPercent = checked.filter(v => v === 3 || v === 5).reduce((a,b)=>a+b, 0);

    // 計算最高戰力
    const totalPowerAdd = addExp + currentPower * (addPercent / 100);
    const maxPower = Math.round((currentPower + totalPowerAdd) * 1.05 / 0.95);

    results.push(`${attr.emoji}最高戰力: ${maxPower}`);
  });

  document.getElementById('powerBooksResult').innerHTML = results.join('<br>');
}
</script>

</body>
</html>
