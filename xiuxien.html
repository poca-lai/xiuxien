<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¿®ç‚ºèˆ‡æˆ°åŠ›è¨ˆç®—å™¨</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; max-width: 600px; margin: auto; }
  h2 { text-align: center; }
  fieldset { margin-top: 20px; padding: 10px; }
  label { display: block; margin-top: 10px; }
  select, input, button { 
    margin-top: 5px; 
    padding: 8px; 
    font-size: 1em; 
    width: 100%; 
    box-sizing: border-box; 
  }
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  button { cursor: pointer; margin-top: 15px; }
  #result, #powerResult { margin-top: 15px; font-weight: bold; }
  hr { margin: 15px 0; }

  /* Checkbox å°é½Šæ¨£å¼ */
  .checkbox-label {
    display: inline-flex;
    align-items: center;
    margin-right: 10px;
    margin-top: 5px;
  }
  .checkbox-label input[type="checkbox"] {
    margin-right: 5px; /* checkbox èˆ‡æ–‡å­—é–“è· */
    vertical-align: middle;
  }
</style>
</head>
<body>

<h2>ä¿®ä»™è¨ˆç®—æ©Ÿ</h2>
<fieldset style="padding:10px; margin-bottom:20px;">
  <legend>ä¿®ç‚ºè¨ˆç®—</legend>

  <!-- ç•¶å‰å¢ƒç•Œé¸æ“‡ -->
  <label>ç•¶å‰å¢ƒç•Œ:
    <select id="stageSelect"></select>
  </label>
  <label>ç•¶å‰éšæ®µé€²åº¦:
    <select id="subStageSelect">
      <option value="å‰æœŸ">å‰æœŸ</option>
      <option value="ä¸­æœŸ">ä¸­æœŸ</option>
      <option value="å¾ŒæœŸ">å¾ŒæœŸ</option>
    </select>
  </label>
  <label>ç›®å‰ç¶“é©—:
    <input type="number" id="currentExp" value="0">
  </label>
    <label>å…ƒæ°£ä¸¹è£œå›:
    <input type="number" id="exExp" value="0">
  </label>
  <!-- ç›®æ¨™å¢ƒç•Œé¸æ“‡ -->
  <label>ç›®æ¨™å¢ƒç•Œ:
    <select id="targetSelect"></select>
  </label>

  <!-- ä¸ƒç¨®åŠ æˆ + è¦ªå¯†åŠ æˆ -->
  <label>å†°å¿ƒï¼š
    <select id="bingxinSelect">
      <option value="0">0</option>
      <option value="1">1ç­‰</option>
      <option value="2">3ç­‰</option>
      <option value="3">5ç­‰</option>
    </select>
  </label>
  <label>è¦ªå¯†åŠ æˆï¼š
    <select id="qinmiSelect">
      <option value="0">0</option>
      <option value="1">1äºº 5%</option>
      <option value="2">2äºº 10%</option>
      <option value="3">3äºº 15%</option>
    </select>
  </label>
<label>èšéˆä¸¹ï¼š
  <select id="julingdanSelect">
    <option value="0">0é¡†</option>
    <option value="1">1é¡†</option>
    <option value="2">2é¡†</option>
    <option value="3">3é¡†</option>
    <option value="4">4é¡†</option>
    <option value="5">5é¡†</option>
    <option value="6">6é¡†</option>
  </select>
  æŒçºŒæ™‚é–“(hr):
  <select id="julingdanTime">
    <option value="0">0</option>
    <option value="0.5">0.5</option>
    <option value="1">1</option>
    <option value="1.5">1.5</option>
    <option value="2">2</option>
  </select>
</label>

<label>å¹½ç„ï¼š
  <select id="youxuanSelect">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</label>

<label>å¤©å‘½ï¼š
  <select id="tianmingSelect">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</label>

<label>ç„å†¥ï¼š
  <select id="xuanmingSelect">
    <option value="0">0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>
</label>

<label>åŠŸæ³•ï¼š
  <br>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="4">4
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="5">5
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="11">11
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="12">12
</label>
<label class="checkbox-label">
  <input type="checkbox" name="gongfaExp" value="18">18
</label>
</label>

 <label>æˆ°æ„ï¼š
    <input type="number" id="zhanyiInput" value="0">
  </label>

  <button onclick="calculate()">è¨ˆç®—å‡æ»¿æ™‚é–“</button>
  <div id="result"></div>
<fieldset style="padding:10px;">
  <legend>æˆ°åŠ›è¨ˆç®—</legend>
  
  <label>æˆ°åŠ›:
    <input type="number" id="currentPower" value="0">
  </label>

  <!-- <label>å¤©ç½¡/éˆæ³‰ç­‰ç´š:
    <select id="tiangangSelect">
      <option value="0">ç„¡</option>
      <option value="2">1: 2%</option>
      <option value="5">2: 5%</option>
      <option value="7">3: 7%</option>
      <option value="10">4: 10%</option>
      <option value="15">5: 15%</option>
    </select>
  </label> -->

  <hr>
<div>
  <strong>æ°´æ›¸ï¼š</strong>
  <label><input type="checkbox" name="waterBook" value="3000">3000</label>
  <label><input type="checkbox" name="waterBook" value="10000">10000</label>
  <label><input type="checkbox" name="waterBook" value="15000">15000</label>
  <label><input type="checkbox" name="waterBook" value="20000">20000</label>
  <label><input type="checkbox" name="waterBook" value="30000">30000</label>
  <label><input type="checkbox" name="waterBook" value="3">3%</label>
  <label><input type="checkbox" name="waterBook" value="5">5%</label>
</div>

<div>
  <strong>ç«æ›¸ï¼š</strong>
  <label><input type="checkbox" name="fireBook" value="3000">3000</label>
  <label><input type="checkbox" name="fireBook" value="10000">10000</label>
  <label><input type="checkbox" name="fireBook" value="15000">15000</label>
  <label><input type="checkbox" name="fireBook" value="20000">20000</label>
  <label><input type="checkbox" name="fireBook" value="30000">30000</label>
  <label><input type="checkbox" name="fireBook" value="3">3%</label>
  <label><input type="checkbox" name="fireBook" value="5">5%</label>
</div>

<div>
  <strong>æœ¨æ›¸ï¼š</strong>
  <label><input type="checkbox" name="woodBook" value="3000">3000</label>
  <label><input type="checkbox" name="woodBook" value="10000">10000</label>
  <label><input type="checkbox" name="woodBook" value="15000">15000</label>
  <label><input type="checkbox" name="woodBook" value="20000">20000</label>
  <label><input type="checkbox" name="woodBook" value="30000">30000</label>
  <label><input type="checkbox" name="woodBook" value="3">3%</label>
  <label><input type="checkbox" name="woodBook" value="5">5%</label>
</div>

<button onclick="calculatePowerBooks()">è¨ˆç®—æœ€é«˜æˆ°åŠ›</button>
<div id="powerBooksResult" style="margin-top:10px; font-weight:bold;"></div>
</fieldset>
<script>
// ç¶“é©—è¡¨
const stages = [
  { name: "1.å‡¡äºº å‰æœŸ", exp: 15, rate: 1 },
  { name: "1.å‡¡äºº ä¸­æœŸ", exp: 25, rate: 1 },
  { name: "1.å‡¡äºº å¾ŒæœŸ", exp: 50, rate: 1 },
  { name: "2.ç…‰æ°£ å‰æœŸ", exp: 100, rate: 1 },
  { name: "2.ç…‰æ°£ ä¸­æœŸ", exp: 440, rate: 1 },
  { name: "2.ç…‰æ°£ å¾ŒæœŸ", exp: 900, rate: 1 },
  { name: "3.ç¯‰åŸº å‰æœŸ", exp: 5400, rate: 3 },
  { name: "3.ç¯‰åŸº ä¸­æœŸ", exp: 13000, rate: 3 },
  { name: "3.ç¯‰åŸº å¾ŒæœŸ", exp: 24150, rate: 3 },
  { name: "4.çµä¸¹ å‰æœŸ", exp: 25000, rate: 5 },
  { name: "4.çµä¸¹ ä¸­æœŸ", exp: 26000, rate: 5 },
  { name: "4.çµä¸¹ å¾ŒæœŸ", exp: 44625, rate: 5 },
  { name: "5.å…ƒå¬° å‰æœŸ", exp: 48825, rate: 5 },
  { name: "5.å…ƒå¬° ä¸­æœŸ", exp: 51240, rate: 5 },
  { name: "5.å…ƒå¬° å¾ŒæœŸ", exp: 54915, rate: 5 },
  { name: "6.å‡ºç«… å‰æœŸ", exp: 56490, rate: 5 },
  { name: "6.å‡ºç«… ä¸­æœŸ", exp: 59325, rate: 5 },
  { name: "6.å‡ºç«… å¾ŒæœŸ", exp: 61950, rate: 5 },
  { name: "7.åŒ–ç¥ å‰æœŸ", exp: 65415, rate: 5 },
  { name: "7.åŒ–ç¥ ä¸­æœŸ", exp: 68670, rate: 5 },
  { name: "7.åŒ–ç¥ å¾ŒæœŸ", exp: 72135, rate: 5 },
  { name: "8.åˆé«” å‰æœŸ", exp: 75705, rate: 10 },
  { name: "8.åˆé«” ä¸­æœŸ", exp: 79485, rate: 10 },
  { name: "8.åˆé«” å¾ŒæœŸ", exp: 166950, rate: 10 },
  { name: "9.æ´è™› å‰æœŸ", exp: 175350, rate: 10 },
  { name: "9.æ´è™› ä¸­æœŸ", exp: 183750, rate: 10 },
  { name: "9.æ´è™› å¾ŒæœŸ", exp: 193200, rate: 10 },
  { name: "10.å¤§æˆ å‰æœŸ", exp: 202965, rate: 10 },
  { name: "10.å¤§æˆ ä¸­æœŸ", exp: 213150, rate: 10 },
  { name: "10.å¤§æˆ å¾ŒæœŸ", exp: 223650, rate: 10 },
  { name: "11.æ¸¡åŠ« å‰æœŸ", exp: 262500, rate: 10 },
  { name: "11.æ¸¡åŠ« ä¸­æœŸ", exp: 283500, rate: 10 },
  { name: "11.æ¸¡åŠ« å¾ŒæœŸ", exp: 315000, rate: 10 },
  { name: "12.äººä»™ å‰æœŸ", exp: 1050000, rate: 30 },
  { name: "12.äººä»™ ä¸­æœŸ", exp: 861000, rate: 30 },
  { name: "12.äººä»™ å¾ŒæœŸ", exp: 903000, rate: 30 },
  { name: "13.çœŸä»™ å‰æœŸ", exp: 924000, rate: 30 },
  { name: "13.çœŸä»™ ä¸­æœŸ", exp: 945000, rate: 30 },
  { name: "13.çœŸä»™ å¾ŒæœŸ", exp: 950985, rate: 30 },
  { name: "14.é‡‘ä»™ å‰æœŸ", exp: 968100, rate: 30 },
  { name: "14.é‡‘ä»™ ä¸­æœŸ", exp: 985530, rate: 30 },
  { name: "14.é‡‘ä»™ å¾ŒæœŸ", exp: 1003275, rate: 30 },
  { name: "15.ä¸Šä»™ å‰æœŸ", exp: 1020000, rate: 30 },
  { name: "15.ä¸Šä»™ ä¸­æœŸ", exp: 1039500, rate: 30 },
  { name: "15.ä¸Šä»™ å¾ŒæœŸ", exp: 1058442, rate: 30 },
  { name: "16.ä»™å› å‰æœŸ", exp: 2520000, rate: 50 },
  { name: "16.ä»™å› ä¸­æœŸ", exp: 1890000, rate: 50 },
  { name: "16.ä»™å› å¾ŒæœŸ", exp: 1942500, rate: 50 },
  { name: "17.ä»™å°Š å‰æœŸ", exp: 2047500, rate: 50 },
  { name: "17.ä»™å°Š ä¸­æœŸ", exp: 2252250, rate: 50 },
  { name: "17.ä»™å°Š å¾ŒæœŸ", exp: 2478000, rate: 50 },
  { name: "18.ä»™å¸ å‰æœŸ", exp: 6300000, rate: 100 },
  { name: "18.ä»™å¸ ä¸­æœŸ", exp: 7035000, rate: 100 },
  { name: "18.ä»™å¸ å¾ŒæœŸ", exp: 7035000, rate: 100 },
];

const stageSelect = document.getElementById('stageSelect');
const targetSelect = document.getElementById('targetSelect');
const subStageSelect = document.getElementById('subStageSelect');
const levels = [...new Set(stages.map(s => s.name.split(' ')[0]))];

// åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
levels.forEach((lvl, i) => {
    const option1 = document.createElement('option');
    option1.value = i;
    option1.text = lvl;
    stageSelect.add(option1);

    const option2 = document.createElement('option');
    option2.value = i;
    option2.text = lvl;
    targetSelect.add(option2);
});

// ç•¶å‰å¢ƒç•Œè®ŠåŒ–æ™‚ï¼Œæ›´æ–°ç›®æ¨™å¢ƒç•Œé¸å–®
stageSelect.addEventListener('change', () => {
    const currentVal = parseInt(stageSelect.value);

    // æ¸…ç©º targetSelect
    targetSelect.innerHTML = '';

    // åªåŠ å…¥ >= ç•¶å‰å¢ƒç•Œçš„é¸é …
    levels.forEach((lvl, i) => {
        if (i >= currentVal) {
            const option = document.createElement('option');
            option.value = i;
            option.text = lvl;
            targetSelect.add(option);
        }
    });

    // é è¨­é¸ä¸­èˆ‡ç•¶å‰å¢ƒç•Œç›¸åŒ
    targetSelect.value = currentVal;
});
// è¨ˆç®—å‡½å¼ï¼ˆç²¾æº–åˆ°åˆ†é˜ï¼‰
function calculate() {
    let currentIndex = parseInt(stageSelect.value) * 3 + subStageSelect.selectedIndex;
    let targetIndex = parseInt(targetSelect.value) * 3 + 2; // ç›®æ¨™å›ºå®šå¾ŒæœŸ
    let currentExp = parseFloat(document.getElementById('currentExp').value);
    let exExp = parseFloat(document.getElementById('exExp').value);
    let zhanyi = parseInt(document.getElementById('zhanyiInput').value);
    let totalTimeSec = 0;

    const bingxin = parseInt(document.getElementById('bingxinSelect').value);
    const jdCount = parseInt(document.getElementById('julingdanSelect').value);
    const youxuan = parseInt(document.getElementById('youxuanSelect').value);
    const tianming = parseInt(document.getElementById('tianmingSelect').value);
    const xuanming = parseInt(document.getElementById('xuanmingSelect').value);
    const qinmi = parseInt(document.getElementById('qinmiSelect').value);

    const checkedGongfa = Array.from(document.querySelectorAll('input[name="gongfaExp"]:checked'))
                               .map(cb => parseInt(cb.value));

    while (currentIndex <= targetIndex) {
        const stage = stages[currentIndex];
        let rate = stage.rate;

        if (bingxin > 0) rate += bingxin;
        if (jdCount > 0) rate += stage.rate * (0.16 + 0.04 * (jdCount - 1));
        rate += stage.rate * (youxuan * 0.01 + tianming * 0.01 + xuanming * 0.01);
        checkedGongfa.forEach(val => {
            if (val == 4 || val == 5) rate += stage.rate * 0.05;
            else if (val == 11) rate += stage.rate * 0.15;
            else if (val == 12) rate += stage.rate * 0.3;
            else if (val == 18) rate += stage.rate * 0.7;
        });

        while (currentExp < stage.exp) {
            let nowHour = new Date().getHours();
            let totalRate = rate;

            if (qinmi > 0 && nowHour >= 9) {
                totalRate += stage.rate * 0.05 * qinmi;
            }

            let zhanyiRate = 0;
            if (zhanyi >= 0 && zhanyi <= 500) zhanyiRate = 0.03;
            else if (zhanyi <= 1000) zhanyiRate = 0.05;
            else if (zhanyi <= 1500) zhanyiRate = 0.07;
            else if (zhanyi <= 2000) zhanyiRate = 0.15;
            totalRate += stage.rate * zhanyiRate;

            let remainExp = stage.exp - currentExp - exExp;
            if (totalRate <= 0) break;

            // ç²¾æº–ç§’æ•¸è¨ˆç®—
            let secToFull = remainExp / totalRate;
            totalTimeSec += secToFull;
            currentExp = stage.exp;

            zhanyi = Math.max(0, zhanyi - (200 * secToFull / 3600));
        }

        currentIndex++;
        currentExp = 0;
    }

    const totalHr = totalTimeSec / 3600;
    const hours = Math.floor(totalHr);
    const minutes = Math.round((totalHr - hours) * 60);
    const now = new Date();
    const finishTime = new Date(now.getTime() + totalTimeSec * 1000);
    const finishYear = finishTime.getFullYear();
    const finishMonth = (finishTime.getMonth()+1).toString().padStart(2,'0');
    const finishDate = finishTime.getDate().toString().padStart(2,'0');
    const finishHour = finishTime.getHours().toString().padStart(2,'0');
    const finishMin = finishTime.getMinutes().toString().padStart(2,'0');

    document.getElementById('result').innerHTML =
        `ç¸½å‰©é¤˜æ™‚é–“: ${hours}å°æ™‚ ${minutes}åˆ†é˜<br>` +
        `é ä¼°å®Œæˆæ™‚é–“: ${finishYear}-${finishMonth}-${finishDate} ${finishHour}:${finishMin}`;
}

function calculatePowerBooks() {
  const currentPower = parseFloat(document.getElementById('currentPower').value) || 0;

  const attrs = [
    { name: 'waterBook', emoji: 'ğŸ’¦' },
    { name: 'fireBook', emoji: 'ğŸ”¥' },
    { name: 'woodBook', emoji: 'ğŸªµ' }
  ];

  let results = [];

  attrs.forEach(attr => {
    const checked = Array.from(document.querySelectorAll(`input[name="${attr.name}"]:checked`))
                         .map(cb => parseFloat(cb.value));

    // åˆ†é–‹æ•¸å€¼å’Œç™¾åˆ†æ¯”
    let addExp = checked.filter(v => v >= 0 && v <= 30000).reduce((a,b)=>a+b, 0);
    let addPercent = checked.filter(v => v === 3 || v === 5).reduce((a,b)=>a+b, 0);

    // è¨ˆç®—æœ€é«˜æˆ°åŠ›
    const totalPowerAdd = addExp + currentPower * (addPercent / 100);
    const maxPower = Math.round((currentPower + totalPowerAdd) * 1.05 / 0.95);

    results.push(`${attr.emoji}æœ€é«˜æˆ°åŠ›: ${maxPower}`);
  });

  document.getElementById('powerBooksResult').innerHTML = results.join('<br>');
}
</script>

</body>
</html>
